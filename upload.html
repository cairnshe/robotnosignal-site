<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Product â€“ Robot No Signal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"/>
</head>
<body class="bg-gray-100 text-gray-800">
  <nav class="bg-orange-500 text-white px-6 py-4 flex justify-between items-center">
    <div class="flex gap-4 items-center">
      <a href="/shop.html" class="hover:underline">ğŸ›ï¸ Shop</a>
      <a href="/main.html" class="hover:underline">ğŸ  My Home</a>
      <span class="font-bold text-lg">ğŸ“¤ Upload Product</span>
    </div>
<button id="logout-btn" class="text-sm text-white font-semibold hover:underline">Logout</button>

  </nav>

  <main class="max-w-xl mx-auto mt-10 p-6 bg-white rounded-lg shadow">
    <h2 class="text-2xl font-bold mb-6">Upload a New Product</h2>
    <form id="upload-form" class="space-y-4">
      <input type="text" id="name" placeholder="Product Name" required class="w-full border p-2 rounded" />
      <textarea id="description" placeholder="Product Description" required class="w-full border p-2 rounded"></textarea>
      <input type="number" id="price" placeholder="Starting Price (CAD)" required class="w-full border p-2 rounded" />
      <input type="url" id="image_url" placeholder="Image URL (GitHub/raw link temporarily)" required class="w-full border p-2 rounded" />
      <img id="preview" class="w-full rounded mb-4 hidden" />

     <label for="ends_at" class="block text-sm font-medium text-gray-700">â° Auction Ends At</label>
<input type="datetime-local" id="ends_at" required class="w-full border p-2 rounded" />

<div class="mt-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“¦ Delivery Options</label>
  <div class="flex flex-col gap-2">
    <label class="inline-flex items-center">
      <input type="checkbox" id="shipping_enabled" class="mr-2" />
      Enable Shipping (Buyer pays shipping fee)
    </label>
    <div id="shipping-fee-group" class="ml-6 hidden">
      <label for="shipping_fee" class="block text-sm font-medium text-gray-700">ğŸšš Shipping Fee (CAD)</label>
      <input type="number" id="shipping_fee" placeholder="e.g. 5.00" class="w-full border p-2 rounded" />
    </div>

    <label class="inline-flex items-center">
      <input type="checkbox" id="pickup_enabled" class="mr-2" />
      Enable Pickup (Must be admin-approved)
    </label>
    <div id="pickup-address-group" class="ml-6 hidden">
  <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“ Pickup Location (must be admin-approved)</label>
  <div class="grid grid-cols-1 gap-3 sm:grid-cols-3">
    <div>

      <label class="text-sm text-gray-600 block mb-1">Country</label>
      <select id="pickup_country" required class="w-full border p-2 rounded">
        <option value="Canada">Canada</option>
      </select>
    </div>
    <div>
      <label class="text-sm text-gray-600 block mb-1">Province</label>
      <select id="pickup_province" required class="w-full border p-2 rounded">
        <option value="">Select Province</option>
      </select>
    </div>
    <div>
      <label class="text-sm text-gray-600 block mb-1">City</label>
      <select id="pickup_city" required class="w-full border p-2 rounded">
        <option value="">Select City</option>
      </select>
    </div>
  </div>
  <p class="text-yellow-600 text-sm mt-2">âš ï¸ Pickup requests require admin approval.</p>
</div>
  </div>
</div>

<!-- ğŸ“ Seller Shipping Address -->
<div class="mt-6">
  <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“¬ Seller Shipping Address (required)</label>
  <div class="grid grid-cols-1 gap-3 sm:grid-cols-3">
    <div>
      <label class="text-sm text-gray-600 block mb-1">Country</label>
      <select id="country" required class="w-full border p-2 rounded">
        <option value="Canada">Canada</option>
      </select>
    </div>
    <div>
      <label class="text-sm text-gray-600 block mb-1">Province</label>
      <select id="province" required class="w-full border p-2 rounded">
        <option value="">Select Province</option>
      </select>
    </div>
    <div>
      <label class="text-sm text-gray-600 block mb-1">City</label>
      <select id="city" required class="w-full border p-2 rounded">
        <option value="">Select City</option>
      </select>
    </div>
  </div>
</div>
      
   <button id="submit-btn" type="submit" style="background-color: orange; color: white; padding: 10px; border: none; width: 100%; font-weight: bold; border-radius: 4px;">
  âœ… Upload Product
</button>

      <p id="message" class="text-center text-sm text-red-600"></p>
    </form>
  </main>

  <script type="module">
   import { auth, db } from '/js/firebase-config.js';
    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import {
      collection,
      addDoc,
      serverTimestamp,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ğŸ—ºï¸ Canada çœä»½-åŸå¸‚æ˜ å°„
// âœ… æ›¿æ¢æˆè¿™ä¸ªå®Œæ•´ç‰ˆæœ¬
const provinceCityMap = {
  "Alberta": [
    "Airdrie", "Calgary", "Edmonton", "Fort McMurray", "Grande Prairie",
    "Leduc", "Lethbridge", "Medicine Hat", "Red Deer", "Spruce Grove",
    "St. Albert"
  ],
  "British Columbia": [
    "Abbotsford", "Burnaby", "Chilliwack", "Coquitlam", "Kamloops", "Kelowna",
    "Langley", "Maple Ridge", "Nanaimo", "New Westminster", "Penticton",
    "Prince George", "Richmond", "Surrey", "Vancouver", "Victoria", "Vernon"
  ],
  "Manitoba": [
    "Brandon", "Portage la Prairie", "Steinbach", "Thompson", "Winnipeg"
  ],
  "New Brunswick": [
    "Bathurst", "Dieppe", "Fredericton", "Miramichi", "Moncton", "Saint John"
  ],
  "Newfoundland and Labrador": [
    "Corner Brook", "Gander", "Happy Valleyâ€‘Goose Bay", "Mount Pearl",
    "St. John's"
  ],
  "Northwest Territories": [
    "Fort Smith", "Hay River", "Inuvik", "Yellowknife"
  ],
  "Nova Scotia": [
    "Halifax", "Kentville", "New Glasgow", "Sydney", "Truro"
  ],
  "Nunavut": [
    "Iqaluit", "Rankin Inlet"
  ],
  "Ontario": [
    "Ajax", "Aurora", "Barrie", "Brampton", "Burlington", "Cambridge",
    "Clarington", "Etobicoke", "Guelph", "Hamilton", "Kingston", "Kitchener",
    "London", "Markham", "Milton", "Mississauga", "Newmarket", "Niagara Falls",
    "North Bay", "Oakville", "Oshawa", "Ottawa", "Peterborough", "Pickering",
    "Scarborough", "St. Catharines", "Thunder Bay", "Toronto", "Vaughan",
    "Waterloo", "Whitby", "Windsor"
  ],
  "Prince Edward Island": [
    "Charlottetown", "Stratford", "Summerside"
  ],
  "Quebec": [
    "Brossard", "Drummondville", "Gatineau", "Laval", "Levis", "Longueuil",
    "Montreal", "Quebec City", "Repentigny", "Saguenay", "Sherbrooke",
    "Trois-RiviÃ¨res", "Terrebonne"
  ],
  "Saskatchewan": [
    "Moose Jaw", "Prince Albert", "Regina", "Saskatoon", "Swift Current",
    "Yorkton"
  ],
  "Yukon": [
    "Dawson City", "Whitehorse"
  ]
};


const provinceSelect = document.getElementById("province");
const citySelect = document.getElementById("city");

const pickupProvinceSelect = document.getElementById("pickup_province");
const pickupCitySelect = document.getElementById("pickup_city");

pickupProvinceSelect.addEventListener("change", () => {
  const cities = provinceCityMap[pickupProvinceSelect.value] || [];
  pickupCitySelect.innerHTML = '<option value="">Select City</option>';
  cities.forEach(city => {
    const option = document.createElement("option");
    option.value = city;
    option.textContent = city;
    pickupCitySelect.appendChild(option);
  });
});

// åŠ è½½ pickup çœä»½åˆ—è¡¨
for (const province in provinceCityMap) {
  const option = document.createElement("option");
  option.value = province;
  option.textContent = province;
  pickupProvinceSelect.appendChild(option);
}
    
// åŠ è½½æ‰€æœ‰çœä»½
for (const province in provinceCityMap) {
  const option = document.createElement("option");
  option.value = province;
  option.textContent = province;
  provinceSelect.appendChild(option);
}

// å½“é€‰æ‹©çœä»½åæ›´æ–°åŸå¸‚
provinceSelect.addEventListener("change", () => {
  const cities = provinceCityMap[provinceSelect.value] || [];
  citySelect.innerHTML = '<option value="">Select City</option>';
  cities.forEach(city => {
    const option = document.createElement("option");
    option.value = city;
    option.textContent = city;
    citySelect.appendChild(option);
  });
});

    const form = document.getElementById("upload-form");
    const message = document.getElementById("message");
    const logoutBtn = document.getElementById("logout-btn");

    
// [ADD] æäº¤æŒ‰é’®å¼•ç”¨ï¼ˆä½ çš„ä»£ç é‡Œåé¢å¤šå¤„ç”¨åˆ°äº† submitBtnï¼Œä½†æ²¡æœ‰å®šä¹‰ï¼‰
const submitBtn = document.getElementById("submit-btn");

// [ADD] å›¾ç‰‡ URL é¢„è§ˆï¼ˆä½ å·²ç»æœ‰ <img id="preview"> äº†ï¼Œè¿™é‡ŒæŠŠå®ƒâ€œè¿èµ·æ¥â€ï¼‰
const imageUrlInput = document.getElementById("image_url");
const previewImg = document.getElementById("preview");
imageUrlInput.addEventListener("input", () => {
  const url = imageUrlInput.value.trim();
  if (url) {
    previewImg.src = url;
    previewImg.classList.remove("hidden");
  } else {
    previewImg.src = "";
    previewImg.classList.add("hidden");
  }
});

 let currentUser = null;

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "/login.html";
  } else {
    currentUser = user;
  }
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  // ğŸ”µ A å¤„ï¼šå…ˆç¦ç”¨æŒ‰é’® + æç¤ºä¸Šä¼ ä¸­
  submitBtn.disabled = true;
  submitBtn.innerText = "Uploading...";
  message.style.color = "#374151";
  message.innerText = "â³ Uploading your product...";

  const name = document.getElementById("name").value.trim();
  const description = document.getElementById("description").value.trim();
  const price = parseFloat(document.getElementById("price").value);
  const imageUrl = document.getElementById("image_url").value.trim();
  const endsAtRaw = document.getElementById("ends_at").value;

  if (!name || !description || !imageUrl || isNaN(price) || !endsAtRaw) {
    message.style.color = "red";
    message.innerText = "Please fill out all fields.";
    submitBtn.disabled = false;
    submitBtn.innerText = "âœ… Upload Product";
    return;
  }

  const endsAt = Timestamp.fromDate(new Date(endsAtRaw));

  // è¿è´¹/è‡ªæé€‰é¡¹
  const shippingEnabled = document.getElementById("shipping_enabled").checked;
  const pickupEnabled   = document.getElementById("pickup_enabled").checked;

  // è¿è´¹æ ¡éªŒ
  let shippingFee = 0;
  if (shippingEnabled) {
    const shippingFeeRaw = document.getElementById("shipping_fee").value.trim();
    if (shippingFeeRaw === "") {
      const confirmZero = confirm("âš ï¸ You enabled shipping but did not enter a shipping fee. It will default to $0. Do you want to continue?");
      if (!confirmZero) {
        message.style.color = "red";
        message.innerText = "âŒ Upload cancelled. Please enter a shipping fee.";
        submitBtn.disabled = false;
        submitBtn.innerText = "âœ… Upload Product";
        return;
      }
      shippingFee = 0;
    } else {
      shippingFee = parseFloat(shippingFeeRaw);
      if (isNaN(shippingFee)) {
        message.style.color = "red";
        message.innerText = "âŒ Please enter a valid shipping fee.";
        submitBtn.disabled = false;
        submitBtn.innerText = "âœ… Upload Product";
        return;
      }
    }
  }

  // pickup åœ°å€ï¼ˆè‹¥å¯ç”¨ï¼‰
  let pickupAddress = null;
  if (pickupEnabled) {
    const pCountry  = document.getElementById("pickup_country").value;
    const pProvince = document.getElementById("pickup_province").value;
    const pCity     = document.getElementById("pickup_city").value;

    if (!pCountry || !pProvince || !pCity) {
      message.style.color = "red";
      message.innerText = "âŒ Please select your pickup address.";
      submitBtn.disabled = false;
      submitBtn.innerText = "âœ… Upload Product";
      return;
    }
    pickupAddress = { country: pCountry, province: pProvince, city: pCity };
  }

  // å–å®¶å‘è´§åœ°å€ï¼ˆå¿…å¡«ï¼‰
  const country  = document.getElementById("country").value;
  const province = document.getElementById("province").value;
  const city     = document.getElementById("city").value;
  if (!country || !province || !city) {
    message.style.color = "red";
    message.innerText = "âŒ Please select your shipping address (country, province, city).";
    submitBtn.disabled = false;
    submitBtn.innerText = "âœ… Upload Product";
    return;
  }

  try {
    await addDoc(collection(db, "products"), {
      // åŸºæœ¬ä¿¡æ¯
      name,
      price,
      description,
      image_url: imageUrl,

      // èº«ä»½å­—æ®µï¼ˆshop.js ç”¨åˆ° seller_uidï¼‰
      seller_uid: currentUser.uid,
      uploader_uid: currentUser.uid, // å…¼å®¹æ—§é€»è¾‘
      seller_name: currentUser.email || "Anonymous",

      // æ‹å–å­—æ®µ
      starting_bid: price,
      bids: [],
      current_bid: price,
      ends_at: endsAt,

      // ç‰©æµå­—æ®µ
      shipping_enabled: shippingEnabled,
      shipping_fee: shippingFee,
      pickup_enabled: pickupEnabled,
      pickup_address: pickupAddress,
      shipping_address: { country, province, city },

      // æ˜“è´§é»˜è®¤æœªé”å®š
      barter_locked: false,

      created_at: serverTimestamp()
    });

    form.reset();
    message.style.color = "green";
    message.innerText = "âœ… Product uploaded successfully! Redirecting...";
    setTimeout(() => {
      window.location.href = "/main.html";
    }, 1200);
  } catch (err) {
    console.error("Upload failed:", err);
    message.style.color = "red";
    message.innerText = "âŒ Upload failed. Try again.";
    submitBtn.disabled = false;
    submitBtn.innerText = "âœ… Upload Product";
  }
});

    
const shippingCheckbox = document.getElementById("shipping_enabled");
const pickupCheckbox = document.getElementById("pickup_enabled");
const shippingFeeGroup = document.getElementById("shipping-fee-group");
const pickupAddressGroup = document.getElementById("pickup-address-group");

shippingCheckbox.addEventListener("change", () => {
  shippingFeeGroup.classList.toggle("hidden", !shippingCheckbox.checked);
});

pickupCheckbox.addEventListener("change", () => {
  pickupAddressGroup.classList.toggle("hidden", !pickupCheckbox.checked);
});
    
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "/login.html";
    });
  </script>
</body>
</html>
